---
title: gc.collect()
date: 2025-01-17 16:00:00
toc: true
tags: [python]
categories: [python]




---

#

<!-- more -->

- [参考链接](https://blog.csdn.net/fyfugoyfa/article/details/137560357)



在 Python 中，gc.collect() 命令是用于手动触发垃圾回收机制，以回收无法访问的对象所占用的内存。Python 的垃圾回收机制主要基于引用计数，辅以 “标记-清除” 和 “分代回收” 算法来处理循环引用和长期存活的对象的内存管理。

引用计数是 Python 自动化内存管理的核心，每当对象被引用时，其引用计数增加；当引用被删除或引用范围结束时，引用计数减少。如果一个对象的引用计数降到 0，表示此对象不再被需要，Python 会立即回收这部分内存。然而，仅靠引用计数无法解决循环引用的问题，即两个或多个对象相互引用，形成闭环，即使它们已不再被其他对象引用，它们的引用计数也不会降到 0。为了解决这个问题，Python 引入了 “标记-清除” 和 “分代回收” 算法。

gc.collect() 命令就是在需要的时候，手动触发这些垃圾回收机制，特别是在处理大量数据并且预期会产生很多无法访问的对象时，使用 gc.collect() 可以及时回收这些对象占用的内存，从而避免内存泄露。该命令会执行 “标记-清除” 和 “分代回收” 算法，回收那些仅靠引用计数无法处理的循环引用对象。

在实际应用中，gc.collect() 经常在执行了大量内存操作之后调用，比如在数据处理、清洗过程中，或在完成一次复杂计算后。这有助于确保不再需要的内存被及时释放，特别是在内存资源受限的环境中，合理使用 gc.collect() 能够显著提高内存使用效率和程序性能。然而，频繁调用 gc.collect() 可能会导致程序性能下降，因为垃圾回收过程本身也是需要消耗资源的。因此，应当根据实际情况合理安排 gc.collect() 的调用时机。

一些思考：

我们可以考虑在程序设计阶段就预防循环引用的产生，或者在数据处理过程中更加注意内存管理，以减少对 gc.collect() 的依赖。

另外，我们可以探索 Python 的其他内存管理工具和技术，比如使用 weakref 模块来处理循环引用，或者使用 resource 模块来监控内存使用情况，这样可以在内存使用达到一定阈值时触发垃圾回收，而不是盲目地调用 gc.collect()。

最后，我们可以考虑使用一些第三方库，如 objgraph，来帮助我们更好地理解和管理 Python 的内存使用。这些库可以提供更深入的内存分析和可视化工具，帮助我们找到和解决内存问题。这是一个值得进一步研究的创新想法。

weakref 模块使 Python 程序员能够创建对象的弱引用，这意味着一旦对象仅剩下弱引用，垃圾回收机制可以销毁该对象。弱引用主要用于实现大型对象的缓存或映射，同时不会因缓存或映射中的存在而阻止对象被垃圾回收。weakref 模块提供了 WeakKeyDictionary 和 WeakValueDictionary 类，用于创建不会因映射中的对象而保持对象存活的映射。此外，weakref 还提供了 finalize 功能，允许注册对象在被垃圾收集时调用清理函数，从而简化了生命周期管理。虽然并非所有对象都支持弱引用，但大多数 Python 标准类型都支持。这个模块的功能在资源管理和避免内存泄露方面非常有用，特别是在某些特定场景下。

resource 模块主要用于测量和控制程序使用的系统资源，特别适用于 Unix 系统，但不支持 Emscripten 和 WASI。通过该模块，用户可以利用符号常量查询和限制进程及其子进程的资源使用情况。资源限制分为软限制和硬限制，可以通过 setrlimit() 函数进行控制。此外，resource 模块还提供了获取资源使用信息（getrusage）、设置和获取任意进程的资源限制（prlimit）以及获取系统页面大小（getpagesize）等功能。需要注意的是，该模块支持的特定资源和限制取决于底层操作系统，并且在某些情况下可能会触发 OSError 或 ValueError 异常。

objgraph 是一个模块，允许用户可视化地探索 Python 对象图。如果想要绘制图形，需要安装 graphviz，并推荐使用 xdot 进行交互式使用。可以通过 pip install objgraph 或从 PyPI 下载来安装此模块。文档位于 https://mg.pov.lt/objgraph。objgraph 的开发起源于作者在寻找 Python 程序内存泄漏时开发的一套函数。源代码托管在 https://github.com/mgedmin/objgraph 的 Git 仓库中，报告问题请至 https://github.com/mgedmin/objgraph/issues。
